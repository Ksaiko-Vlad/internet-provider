<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <title>Профиль пользователя</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="/profile.css">
</head>
<body>
<div th:insert="~{fragments/header :: header}"></div>

<div class="container mt-4">
  <h5 th:text="${username}">Имя пользователя</h5>

  <form id="profile-form" th:action="@{/user/profile}" method="post" novalidate>
    <!-- Имя пользователя -->
    <div class="mb-3">
      <label for="username" class="form-label">Имя пользователя</label>
      <input type="text" class="form-control" id="username" name="username" th:value="${username ?: ''}" placeholder="Введите имя пользователя" required>
      <div th:if="${usernameError}" class="text-danger small">
        <span th:text="${usernameError}"></span>
      </div>
    </div>

    <!-- Номер телефона -->
    <div class="mb-3">
      <label for="phone" class="form-label">Номер телефона</label>
      <div class="input-group">
        <span class="input-group-text">+375</span>
        <input type="text" class="form-control" id="phone" name="phone" th:value="${phone ?: ''}" placeholder="Введите номер телефона (9 цифр)" required>
      </div>
      <div th:if="${phoneError}" class="text-danger small">
        <span th:text="${phoneError}"></span>
      </div>
    </div>

    <!-- Пароль -->
    <div class="mb-3">
      <label for="password" class="form-label">Пароль</label>
      <input type="password" class="form-control" id="password" name="password" placeholder="Введите пароль" required>
    </div>

    <!-- Общий контейнер для ошибок (клиентская валидация) -->
    <div id="error-messages" class="alert alert-danger d-none"></div>

    <!-- CSRF токен -->
    <input type="hidden" name="_csrf" th:value="${_csrf.token}" />

    <!-- Кнопка отправки -->
    <div class="d-grid">
      <button type="submit" class="btn btn-primary">Сохранить</button>
    </div>
  </form>

  <h2 class="my-5">Ваши заказы</h2>

  <div th:if="${orders != null && orders.size() > 0}">
    <div class="row">
      <div class="col-md-4 mb-4" th:each="order, iterStat : ${orders}">
        <div class="card d-flex" style="height: 100%">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">Номер заказа: <span th:text="${iterStat.index + 1}">1</span></h5>
            <p><strong>Дата:</strong> <span th:text="${order.time}">2024-11-17 22:18:53</span></p>

            <h6 class="mt-3">Список услуг:</h6>
            <ul>
              <li th:each="product : ${order.products}" th:text="${product.name}">Продукт</li>
            </ul>

            <!-- Кнопка оставить отзыв -->
            <div class="mt-auto">
              <a th:href="@{/feedback/add/{orderId}(orderId=${order.id})}" class="btn btn-primary w-100">Оставить отзыв</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:if="${orders == null || orders.size() == 0}" class="mt-3">
  <p>У вас нет заказов.</p>
</div>

<div th:insert="~{fragments/footer :: footer}"></div>

<!-- JavaScript для клиентской валидации -->
<script>
  document.getElementById('profile-form').addEventListener('submit', function (e) {
      e.preventDefault(); // Останавливаем отправку формы

      const errorMessages = [];
      const username = document.getElementById('username').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;

      // Валидация имени пользователя
      if (username.length < 4 || username.length > 12) {
          errorMessages.push('Имя пользователя должно содержать от 4 до 12 символов.');
      }
      if (/\s/.test(username)) {
          errorMessages.push('Имя пользователя не должно содержать пробелы.');
      }

      // Валидация номера телефона
      const phoneRegex = /^\d{9}$/;
      if (!phoneRegex.test(phone)) {
          errorMessages.push('Номер телефона должен содержать ровно 9 цифр (без пробелов и других символов).');
      }

      // Проверка пароля
      if (password && password.length < 6) {
          errorMessages.push('Пароль должен содержать не менее 6 символов.');
      }

      // Обработка ошибок
      const errorContainer = document.getElementById('error-messages');
      if (errorMessages.length > 0) {
          errorContainer.innerHTML = errorMessages.join('<br>');
          errorContainer.classList.remove('d-none');
      } else {
          errorContainer.classList.add('d-none');
          this.submit(); // Если ошибок нет, отправляем форму
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
